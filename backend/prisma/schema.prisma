// backend/prisma/schema.prisma
// Version: 2.1.0
// Updated schema to include proper Report model for content moderation system
// Changes: Added Report enums and model with proper relationships

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Report type enumeration for content moderation
enum ReportType {
  HARASSMENT
  SPAM
  MISINFORMATION
  INAPPROPRIATE_CONTENT
  COPYRIGHT
  OTHER
}

// Report status enumeration for moderation workflow
enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

// ParaSocial user accounts (content creators only)
model User {
  id               String   @id @default(cuid())
  email            String   @unique
  username         String   @unique
  displayName      String?
  bio              String?
  avatar           String?  // URL to avatar image
  website          String?  // Optional website/portfolio link
  passwordHash     String
  isVerified       Boolean  @default(false)
  verificationTier String   @default("none") // none, email, phone, identity, notable
  isActive         Boolean  @default(true)   // For soft account suspension
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // ActivityPub fields for federation
  actorId          String?  @unique // ActivityPub actor URI
  publicKey        String?  // RSA public key for HTTP signatures
  privateKey       String?  // RSA private key (encrypted)
  
  // Relations
  posts            Post[]
  followers        Follow[] @relation("FollowedUser")
  blocks           Block[]  @relation("BlockingUser")
  
  // Report relations - users can be reported, submit reports, and moderate reports
  reportsAgainst    Report[] @relation("ReportedUser")
  reportsSubmitted  Report[] @relation("ReporterUser") 
  reportsModerated  Report[] @relation("ModeratorUser")
  
  @@map("users")
}

// Posts created by ParaSocial users
model Post {
  id             String    @id @default(cuid())
  content        String    // Main post content
  contentWarning String?   // Content warning text
  isScheduled    Boolean   @default(false)
  scheduledFor   DateTime? // When to publish scheduled posts
  isPublished    Boolean   @default(true)  // Draft vs published
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  publishedAt    DateTime? // Actual publication time
  
  // ActivityPub fields
  activityId     String?   @unique // ActivityPub activity URI
  
  // Relations
  authorId       String
  author         User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  media          Media[]   // Attached images/files
  reports        Report[]  @relation("ReportedPost")
  
  @@map("posts")
}

// Media attachments for posts
model Media {
  id          String   @id @default(cuid())
  filename    String   // Original filename
  url         String   // Storage URL
  mimeType    String   // MIME type (image/jpeg, etc.)
  size        Int      // File size in bytes
  altText     String?  // Accessibility description
  width       Int?     // Image dimensions
  height      Int?
  createdAt   DateTime @default(now())
  
  // Relations
  postId      String
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@map("media")
}

// Follow relationships (supports both local and federated)
model Follow {
  id          String   @id @default(cuid())
  followerId  String   // Can be external ActivityPub actor ID
  followedId  String   // Always a ParaSocial user ID
  actorId     String?  // Full ActivityPub actor URI for federated follows
  isAccepted  Boolean  @default(true)  // For future follow request support
  createdAt   DateTime @default(now())
  
  // Relations
  followed    User     @relation("FollowedUser", fields: [followedId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followedId])
  @@map("follows")
}

// User blocking (ParaSocial users can block followers)
model Block {
  id         String   @id @default(cuid())
  blockerId  String   // ParaSocial user doing the blocking
  blockedId  String   // Actor being blocked (can be external)
  reason     String?  // Optional reason for block
  createdAt  DateTime @default(now())
  
  // Relations
  blocker    User     @relation("BlockingUser", fields: [blockerId], references: [id], onDelete: Cascade)
  
  @@unique([blockerId, blockedId])
  @@map("blocks")
}

// Content and user reporting system for moderation
model Report {
  id                String         @id @default(cuid())
  type              ReportType     // Type of violation being reported
  description       String         // Detailed description of the issue
  status            ReportStatus   @default(PENDING) // Current moderation status
  reportedUserId    String?        // Optional - user being reported
  reportedPostId    String?        // Optional - post being reported
  reporterId        String?        // Optional - user who submitted the report (allows anonymous reports)
  reporterActorId   String?        // Optional - ActivityPub actor who reported (for federated reports)
  moderatorNotes    String?        // Optional - notes added during moderation
  moderatorId       String?        // Optional - admin who processed the report
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relationships with proper cascade behavior
  reportedUser      User?          @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  reportedPost      Post?          @relation("ReportedPost", fields: [reportedPostId], references: [id], onDelete: Cascade)
  reporter          User?          @relation("ReporterUser", fields: [reporterId], references: [id], onDelete: SetNull)
  moderator         User?          @relation("ModeratorUser", fields: [moderatorId], references: [id], onDelete: SetNull)

  // Database indexes for performance
  @@index([status])           // Fast filtering by status
  @@index([type])             // Fast filtering by report type
  @@index([reportedUserId])   // Fast lookups for user reports
  @@index([reportedPostId])   // Fast lookups for post reports
  @@index([createdAt])        // Fast sorting by creation date
  @@map("reports")
}

// Federated instance management
model Instance {
  id            String   @id @default(cuid())
  domain        String   @unique
  isBlocked     Boolean  @default(false)
  isSuspended   Boolean  @default(false)  // Temporary suspension
  software      String?  // Mastodon, Pleroma, etc.
  version       String?  // Software version
  description   String?  // Instance description
  lastSeen      DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("instances")
}

// backend/prisma/schema.prisma
// Version: 2.1.0
// Updated schema to include proper Report model for content moderation system